% ********** Sparrow protocol **********

\chapter{Sparrow Protocol}

\todo{intro}

\todo{generalities}

\todo{slot time, guard time}

As mentioned earlier, the main focus of this protocol is to increase network
bandwidth and responsiveness. This is achieved through larger windows of
activity for nodes closer to the gateway. 

\section{Initialization and registering into the network}

After power-on all Sparrow nodes will first read their pre-programmed id from
\mbox{EEPROM} memory and then attempt to register to a network. No restrictions
such as network address or parent id are imposed. As such any distribution of
Sparrow nodes where all leaf nodes are within communication distance of at
least one root node and a path can be formed from any root node to the gateway
will eventually form a network. 

There are two major approaches to registering to a network: the new node can
request registration information from the existing nodes (request method) or
the existing nodes can periodically advertise this information for new nodes
(advertisement method). 

\subsection{Request method}

The first method implies that any new node must broadcast a discovery message,
wait for responses, choose the best parent node from the offers received and
finally register to that node. With this method registration can be
unsuccessful for a number of reasons. Firstly, there may be no root nodes
within communication distance of the new node, however, the most we can do is
set a timeout and, if this timeout is reached and no offer is received, place
the node in a sleep state and retry the procedure after a certain amount of
time. Secondly, there may be root nodes in range but none are awake or in
listening state. This can be partially solved by prolonging root node listening
periods, albeit to the detriment of power consumption. Thirdly, there may be
root nodes in listening mode and in range but the discovery message may be
corrupted by an already scheduled transmission. The possibility of this
happening can be reduced by spacing transmissions evenly within the root node's
listening period. Fourthly, considering that the discovery message was
successfully received, the offer message may be corrupted because two nodes
attempt to respond at the same time. This means that a contention period must
precede any response, lengthening the registering node's listening window and
requiring multiple attempts on the behalf of the root nodes in order to
respond. Lastly, considering that the discovery message was received and there
was at least one offer, the following message sequence, i.e. the actual
registration process, may be corrupted by a scheduled transmission or other
phenomena and the process will have to be repeated.

As can be seen this method implies low costs for the registering nodes as they
must only transmit the discovery message and listen a relatively short time for
offers and they must pay this cost only once, during the registering process.
Root nodes however must listen for long periods of time which implies a high
power cost which must be payed every network period. Furthermore, this method
does not scale well with the number of nodes in the network. The chances of the
discovery message interfering with a scheduled transmission increase with the
number of nodes in the network. The same applies if more nodes are attempting
to register at the same time. This means that as the network grows it will
become increasingly difficult for new nodes to join.

\subsection{Advertisement method}

The second method involves all root nodes periodically transmitting a beacon,
or Router Advertisement, that contains all the information necessary to
register to the network. New nodes must listen for these messages and then
communicate with their chosen parent in order to register.  There are as well
multiple issues that we must address with this procedure. Firstly, there may be
no root nodes in range of the new node so, as with the first method, we can set
a timeout for the registration process. Secondly, although there is at least
one root node in range, the request may interfere with a scheduled
transmission. To avoid this, we reserve a registration slot for each root node
in which it listens for incoming requests and no other communication is
scheduled. Thirdly, although the request may have been sent within the root
node's registration slot, it was corrupted by another node attempting to
register to the same node. This can be resolved by adding a contention slot
before the registration. A node must first listen for a random period of time
and then successfully transmit a message to the root node in the contention
period in order to begin the registration process. Finally, there is no
guarantee that there will be a victor after the contention process. Sparrowv3
nodes have a 17 Î¼s transition delay between listening and transmitting states
which means that if two nodes are offset by less than this they cannot avoid
each other and a collision will happen. This cannot be resolved because two
nodes may choose the same listening period randomly.

This method implies a longer listening period for registering nodes however
this cost must only be paid once. The cost for root nodes is relatively low as
they must only transmit the advertisement message and must have two extra
listening slots. It also scales relatively well with the number of nodes in the
network.  If all contentions have a winner then the mean waiting time scales
proportionally to the number of nodes attempting to register with a root node. 

\vspace{\baselineskip}

As the comparison shows the advertisement method is the better choice for
Wireless Sensor Networks as the average cost of registration is lower and it
scales better with network growth. In our implementation new nodes do not
initially know the network period, so they must extract it from the first
Router Advertisement received. They then wait one network period to collect
advertisements, choose the best root node available as their parent and set a
wake-up timer for the contention slot. In the contention phase the node chooses
a random listening period that is at most the full contention slot. If another
transmission is received, the node goes back to sleep and retries registering
the next period. If there is no other transmission, it sends a registration
request in which it specifies whether it is a root or a leaf node.  Leaf nodes
are allocated one transmission slot whereas root nodes are implicitly allocated
16. If this request is received correctly by the root node, i.e. a conflict has
not occurred, the root node acknowledges the registration and the new node
transitions into normal operating mode.

\section{Leaf node operation}

\section{Root node operation}

\section{Fault conditions and solutions}

% ********** End of Sparrow protocol **********
